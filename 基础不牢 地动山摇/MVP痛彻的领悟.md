前言
渲染管线中用到了很多矩阵，本文就是进行一个详细的推导。

先来看看跟矩阵有关的一些问题：

为什么管线中都是矩阵与点的乘积？
为什么需要用到齐次坐标系？
MVP矩阵是固定的吗？
变换矩阵（Model矩阵）推导
对于变换矩阵首先需要明确两点：

本质上是想对3D顶点所围成三维图形变换，如果将三维图形所有顶点都做相同变换就等价于对三维图形图形做了同等变换。
变换并不是一定需要矩阵，矩阵只是恰好满足变换的要求。
缩放矩阵

先来看看对于点 [公式] 在xyz轴上分别进行 [公式] 缩放，缩放之后的顶点 [公式] ,然后再将其拆分为缩放矩阵：

[公式]

一定要注意，是将缩放的结果拆解为矩阵与向量的乘法，管线中所有的矩阵（包括投影矩阵）都是如此，是变换结果为了统一表示而转化为矩阵乘法。就以缩放而言，如果只有缩放变换，那完全可以不传入矩阵而只需要传入 [公式] 进行缩放即可。

旋转矩阵

假设点 [公式] 围绕x轴旋转 [公式] 度，如下图所示：


可以得出 [公式] ，通过几何关系求 [公式] ：

[公式]

从而得到 [公式] 为：

[公式]

最终得到绕x轴旋转 [公式] 之后的点 [公式] 为 [公式] ，然后将其分解为矩阵与向量乘法为：

[公式]

围绕其他轴旋转的推导同上。从旋转矩阵的推导也能看出，是将旋转的结果拆解为矩阵。关于死锁的问题在后面进行分析。

平移矩阵

对于点 [公式] 分别向xyz方向平移 [公式] 就变成了 [公式] ，然后将其拆解为矩阵与向量的乘积：

[公式]

从式5可以看出，对于平移变换，拆解为矩阵与向量乘积就需要多一个维度，这也是为什么采用四维点和四维矩阵的其中一个原因。

顺序

对于上述三种变换还需要注意顺序，比如先对点进行平移在进行缩放就会变成 [公式] ,这会把平移的距离 [公式] 也进行缩放从而得到不正确的结果。

因此对于点的变换要遵循缩放->旋转->平移的顺序。

视觉矩阵（View矩阵）推导

View矩阵是想把所有顶点从世界坐标系变换到以相机视角下的坐标系，坐标系变换本质上就是平移和旋转操作，因此可以按照上面的变换矩阵方法进行坐标系变换，但更简单方法是直接求出View矩阵。计算View矩阵需要知道相机的位置 [公式] 和相机看向的方向 [公式] 。

首先只考虑平移，即先求出其余点相对于相机的位置.假设当前相机处于世界坐标系的 [公式] ,那么其余点相对于相机的位置为 [公式] 相机平移矩阵为：
[公式]

接下来需要求出相机的坐标轴空间，即上图中相机的三个轴。一般而言我们是通过叉乘求出三个轴向量。
假设Dir向量为新坐标系的z轴
先假设一个Up向量为 [公式]
根据Up向量和Dir向量用叉乘计算出x轴 [公式]
再根据R向量 [公式] 和Dir向量叉乘计算出y轴 [公式]
那么相机的坐标轴空间矩阵为：

[公式]

注意上述矩阵计算方法就是场景的方向死锁出现的地方，如果两两平行（比如垂直向上/下看就会得到Up向量和Dir向量平行）的叉乘平行就会得到一个无效向量从而导致结果错误。解决死锁可以限制角度的范围（比如不然垂直向上向下看），也可以用四元数和旋转矩阵进行规避。

然后根据式6和式7得到View矩阵为：

[公式]

投影矩阵（Projection矩阵）推导
投影矩阵是为了把顶点的 [公式] 坐标都变换到 [公式] 之间（Normalized Device Coordinate, NDC坐标系）。

一般来说坐标变换都是均匀缩放的（除了透视矩阵的z方向），那么映射关系就就是一次函数即：

[公式]

只需要代入变换前后的点解出A，B即可。

根据变换方式的不同，通常分为正交投影矩阵和透视投影矩阵。

透视投影矩阵


透视投影是为了近似眼睛成像的原理，即把一定范围内的顶点都投影到近平面中（眼睛不是平面，这里只是近似的模拟），根据这种投影关系对顶点进行变换。


在x方向，如上图右图所示，假设 [公式] ,假设变换之后的点为 [公式]
[公式]

而将近平面 [公式] 映射到 [公式] （这里假设是中心对称的，否则为 [公式] ）为均匀映射（由于均匀因此为线性的），同时需要注意，[公式] 投影到近平面为同一个点，因此他们在分别进行映射之后的x值应该相同，因此转化为求点Q的映射之后的x坐标：

[公式]

在y方向，求映射之后的y方向坐标与x方向同理为：
[公式]

在z方向进行映射时为了近处的物体能有很大的深度精度而定义的映射关系为：
[公式]

如此一来的深度关系为：


可以看到，深度值很大一部分是由很小的z值所决定的，这给了近处的物体很大的深度精度。

而对于式12，由于需要将 [公式] 映射到 [公式] 代入得：

[公式]

解得A,B为：

[公式]

如此一来对于 [公式] 进行透视投影之后的点 :[公式]

由于 [公式] 到 [公式] 的变换很难直接拆解为矩阵与向量的乘法，因此还引入了透视除法的操作。即规定在管线中对于所有的点最终都会除以点的 [公式] 分量： [公式]

这样的好处就是可以将 [公式] 分量设置为 [公式] 值，然后式15就可以被分解为矩阵与向量的乘积：

[公式]

正交投影矩阵


正交投影就是把一定范围里面的顶点进行线性（均匀）的缩放。

在x方向，将 [公式] 映射到 [公式] （这里假设是中心对称的，否则为 [公式] ）为均匀映射（由于均匀因此为线性的），假设 [公式] ,假设变换之后的点为 [公式]因此变换后的点关系为：
[公式]

在y方向，将 [公式] 映射到 [公式] （这里假设是中心对称的，否则为 [公式] ）[公式]因此变换后的点关系为：
[公式]

在z方向，和xy方向同理不过是将 [公式] 均匀映射到 [公式]
[公式]

如此一来对于 [公式] 进行透视投影之后的点 :[公式]

将 [公式] 到 [公式] 的变换分解为矩阵与点的乘积为：

[公式]

总结
以上就是渲染管线中MPV矩阵的推导，可以看到有些时候需要用四维矩阵，有些时候三维就可以了，为了统一操作，在管线中一律都用齐次坐标系（用四维来表示三维点，即多了一个w维） 。

上述点的变换只是目前最常用的变换方法，并不是非得这样做，比如有的需求需要模拟人眼（人眼是小孔成像+视网膜不为一个平面）这就需要自定义投影变换方法。

同时可以从推导过程看出来，是矩阵与点的乘积只是将变换的结果进行分解而已，没有规定必须这样做，也不是所有点都需要乘以MVP矩阵，一切都要根据需求进行灵活的取舍。
